{% extends 'base.html' %}

{% block content %}
<div class="content-header">
    <div>
        <h1>Traffic Analytics</h1>
        <p>View historical data, violation trends, and system statistics.</p>
    </div>
</div>

<!-- Analytics KPI Row -->
<div class="horizon-metrics" style="margin-bottom: 2rem;">
    <div class="horizon-card glass-panel">
        <div class="horizon-icon" style="color: var(--brand-primary); background: var(--brand-light);">
            <i class="ph ph-chart-line-up"></i>
        </div>
        <div class="horizon-data">
            <p>Total Vehicles Scanned</p>
            <h3 id="analytics-total-scans">--</h3>
        </div>
    </div>
    <div class="horizon-card glass-panel">
        <div class="horizon-icon" style="color: var(--status-warning); background: rgba(245, 158, 11, 0.1);">
            <i class="ph ph-warning-octagon"></i>
        </div>
        <div class="horizon-data">
            <p>Total Violations</p>
            <h3 id="analytics-total-violations">--</h3>
        </div>
    </div>
    <div class="horizon-card glass-panel">
        <div class="horizon-icon" style="color: var(--status-safe); background: rgba(16, 185, 129, 0.1);">
            <i class="ph ph-crosshair"></i>
        </div>
        <div class="horizon-data">
            <p>System Accuracy</p>
            <h3 id="analytics-accuracy">--</h3>
        </div>
    </div>
</div>

<div class="analytics-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">

    <!-- Left Column (Charts) -->
    <div class="analytics-left" style="display: flex; flex-direction: column; gap: 2rem;">

        <!-- Traffic Volume Bar Chart -->
        <div class="glass-panel" style="padding: 1.5rem;">
            <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                <i class="ph ph-chart-bar"></i> Dynamic Traffic Volume
            </h3>
            <div style="height: 250px; width: 100%; position: relative;">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>

        <!-- Violation Breakdown -->
        <div class="glass-panel" style="padding: 1.5rem;">
            <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                <i class="ph ph-chart-pie-slice"></i> Violation Breakdown
            </h3>

            <div class="progress-list" style="display: flex; flex-direction: column; gap: 1.25rem;">
                <!-- Item 1 -->
                <div class="progress-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-size: 0.9rem; font-weight: 500;">No Helmet</span>
                        <span style="font-size: 0.9rem; color: var(--status-danger); font-weight: 600;">68%</span>
                    </div>
                    <div
                        style="width: 100%; height: 8px; background: var(--bg-input); border-radius: 100px; overflow: hidden;">
                        <div style="width: 68%; height: 100%; background: var(--status-danger); border-radius: 100px;">
                        </div>
                    </div>
                </div>

                <!-- Item 2 -->
                <div class="progress-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-size: 0.9rem; font-weight: 500;">Multiple Riders</span>
                        <span style="font-size: 0.9rem; color: var(--status-warning); font-weight: 600;">22%</span>
                    </div>
                    <div
                        style="width: 100%; height: 8px; background: var(--bg-input); border-radius: 100px; overflow: hidden;">
                        <div style="width: 22%; height: 100%; background: var(--status-warning); border-radius: 100px;">
                        </div>
                    </div>
                </div>

                <!-- Item 3 -->
                <div class="progress-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="font-size: 0.9rem; font-weight: 500;">Red Light / Wrong Way</span>
                        <span style="font-size: 0.9rem; color: var(--brand-primary); font-weight: 600;">10%</span>
                    </div>
                    <div
                        style="width: 100%; height: 8px; background: var(--bg-input); border-radius: 100px; overflow: hidden;">
                        <div style="width: 10%; height: 100%; background: var(--brand-primary); border-radius: 100px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Right Column (Status) -->
    <div class="analytics-right" style="display: flex; flex-direction: column; gap: 2rem;">

        <div class="glass-panel" style="padding: 1.5rem; height: 100%;">
            <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                <i class="ph ph-video-camera"></i> Camera Health
            </h3>

            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div
                    style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background: rgba(16, 185, 129, 0.05);">
                    <div
                        style="width: 10px; height: 10px; border-radius: 50%; background: var(--status-safe); box-shadow: 0 0 8px var(--status-safe);">
                    </div>
                    <div style="flex: 1;">
                        <h4 style="font-size: 0.9rem;">CAM 01 - Main Gate</h4>
                        <p style="font-size: 0.75rem; color: var(--text-secondary);">30 FPS | Latency: 12ms</p>
                    </div>
                    <span class="badge badge-safe">Online</span>
                </div>

                <div
                    style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background: rgba(16, 185, 129, 0.05);">
                    <div
                        style="width: 10px; height: 10px; border-radius: 50%; background: var(--status-safe); box-shadow: 0 0 8px var(--status-safe);">
                    </div>
                    <div style="flex: 1;">
                        <h4 style="font-size: 0.9rem;">CAM 02 - Exit North</h4>
                        <p style="font-size: 0.75rem; color: var(--text-secondary);">30 FPS | Latency: 15ms</p>
                    </div>
                    <span class="badge badge-safe">Online</span>
                </div>

                <div
                    style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background: rgba(239, 68, 68, 0.05);">
                    <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--status-danger);"></div>
                    <div style="flex: 1;">
                        <h4 style="font-size: 0.9rem;">CAM 03 - Parking B</h4>
                        <p style="font-size: 0.75rem; color: var(--text-secondary);">Connection Lost</p>
                    </div>
                    <span class="badge badge-danger">Offline</span>
                </div>

                <button class="btn-outline" style="width: 100%; text-align: center; margin-top: 1rem;">
                    <i class="ph ph-plus"></i> Add New Camera
                </button>
            </div>
        </div>

    </div>

</div>

<style>
    @media (max-width: 768px) {
        .analytics-grid {
            grid-template-columns: 1fr !important;
        }
    }
</style>

<!-- Chart.js Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Fetch Top KPIs
        fetch('/api/analytics/stats')
            .then(res => res.json())
            .then(data => {
                document.getElementById('analytics-total-scans').innerText = data.total_scans.toLocaleString();
                document.getElementById('analytics-total-violations').innerText = data.total_violations.toLocaleString();
                document.getElementById('analytics-accuracy').innerText = data.accuracy.toFixed(1) + '%';
            })
            .catch(err => console.error("Error fetching analytics stats:", err));

        // Fetch Chart Data
        fetch('/api/analytics/chart')
            .then(res => res.json())
            .then(data => {
                const ctx = document.getElementById('trafficChart').getContext('2d');

                // Primary brand color: #3b82f6
                // Danger color: #ef4444

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dates,
                        datasets: [
                            {
                                label: 'Total Scans',
                                data: data.totals,
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderRadius: 4,
                            },
                            {
                                label: 'Violations (No Helmet)',
                                data: data.violations,
                                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#9ca3af' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#9ca3af' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#9ca3af' }
                            }
                        }
                    }
                });
            })
            .catch(err => console.error("Error fetching chart data:", err));
    });
</script>
{% endblock %}